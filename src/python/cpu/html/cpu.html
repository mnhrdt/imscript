<!DOCTYPE html>
<title>image zoom and pan</title>

<style>
.cpu {
	/*position: relative;*/
	width: 600px;
	height: 400px;
	overflow: hidden;
	border: 1px solid #000;
	background: #ccc;
//background-color: #e5e5f7;
//opacity: 0.2;
//background-image:  repeating-linear-gradient(45deg, #444cf7 25%, transparent 25%, transparent 75%, #444cf7 75%, #444cf7), repeating-linear-gradient(45deg, #444cf7 25%, #e5e5f7 25%, #e5e5f7 75%, #444cf7 75%, #444cf7);
//background-position: 0 0, 10px 10px;
//background-size: 20px 20px;
}

img {
	/*position: absolute;*/
	image-rendering: pixelated; /* Prevents smoothing */
}
</style>

<script>
	window.onload = function(){
		const cpu = document.getElementById('imageContainer');
		const img = document.getElementById('zoomImage');
		const WHEEL_FACTOR = 2;//1.414213562373;
		let scale = 1;
		let startX = 0;
		let startY = 0;
		let offsetX = 0;
		let offsetY = 0;
		let isPanning = false;

		//img.onload = function() {
		//	resetImagePosition();
		//};

		function viewport_reset() {
			offsetX = 0;
			offsetY = 0;
			scale = 1;
		}

		function viewport_offset(dx, dy) {
			//console.log(`dxy ${dx} ${dy}`);
			offsetX = offsetX + dx;//*scale;
			offsetY = offsetY + dy;//*scale;
		}

		function viewport_scale(x, y, lds) {
			//console.log(`S x=${x} y=${y} lds=${lds} ox=${offsetX} oy=${offsetY}`)
			cx = (x - offsetX)/scale;
			cy = (y - offsetY)/scale;
			scale = lds * scale;
			offsetX = x - cx*scale;
			offsetY = y - cy*scale;
		}

		function apply_transform() {
			x = offsetX;
			y = offsetY;
			s = scale;
			//console.log(`T ${x} ${y} ${s}`);
			img.style.transformOrigin = `left top`;
			img.style.transform = `translate(${x}px, ${y}px) scale(${s})`;
		}

		cpu.addEventListener('wheel', function(event) {
			event.preventDefault();
			const {deltaY} = event;
			const factor = deltaY > 0 ? WHEEL_FACTOR : 1.0/WHEEL_FACTOR;
			x = event.clientX - img.offsetLeft;
			y = event.clientY - img.offsetTop;
			viewport_scale(x, y, factor)
			apply_transform();
		});


		cpu.addEventListener('mousedown', function(event) {
			event.preventDefault();
			if (event.which == 3) {
				viewport_reset();
				apply_transform();
			} else {
				isPanning = true;
				startX = event.clientX - img.offsetLeft;
				startY = event.clientY - img.offsetTop;
				cpu.style.cursor = 'grabbing';
				//console.log(`grab ${startX} ${startY} cx=${event.clientX} oL=${img.offsetLeft} oT=${img.offsetTop}`);
			}
		});

		cpu.addEventListener('mousemove', function(event) {
			if (isPanning) {
				event.preventDefault();
				const dx = event.clientX - img.offsetLeft - startX;
				const dy = event.clientY - img.offsetTop - startY;
				viewport_offset(dx, dy);
				apply_transform();
				startX = event.clientX - img.offsetLeft;
				startY = event.clientY - img.offsetTop;
			}
		});

		cpu.addEventListener('mouseup', function(event) {
			if (isPanning) {
				isPanning = false;
				cpu.style.cursor = 'grab';
				//window.cursor = 'grab';
			}
		});

		cpu.addEventListener('mouseleave', function(event) {
			isPanning = false;
		});

	}
</script>


<h1>image zoom and pan</h1>

<p>First image:
<div class="cpu" id="imageContainer">
	<img src="http://gabarro.org/img/barbara.png" id="zoomImage">
</div>

<p>Second image (does not work yet):
<!-- TODO: see https://stackoverflow.com/questions/73922207/can-a-javascript-variable-be-made-local-to-a-specific-html-element -->
<div class="cpu" id="imageContainer">
	<img src="http://gabarro.org/img/lenak.png" id="zoomImage">
</div>

<p>Current situation:
<ol>
	<li>Implementation using css transforms
	<li>Working pan and buggy zoom
	<li>No contrast changes
	<li>Limited to one widget per page (uses global variables as state)
</ol>

<p>Near-term work (with css transforms):
<ol>
	<li>Fix zoom center
	<li>Add simple contrast changes (limited to 8 or 16 bit png images)
</ol>

<p>Near-term work (with the javascript context):
<ol>
	<li>Make it work with multiple widgets per page
	<li>Integrate seamlessly into notebooks
	<li>Gallery3 environment to share pans between images of the same group
	<li>iio integration: add a new .view method
</ol>

<p>Future work (with canvas):
<ol>
	<li>Canvas reimplementation with the same functionality
	<li>Read numpy arrays from the notebook or .npy file
	<li>Advanced contrast changes
	<li>Single pixel explorer (impossible with css transforms)
	<li>Well-thought out mouse gestures (to reset zoom and contrast, etc.)
	<li>Inconspicuous but complete help tooltips
	<li>Affordances to indicate borders, image exterior, maybe click to "start"
</ol>

<!-- vim: set ts=3 sw=3 ft=javascript: -->
